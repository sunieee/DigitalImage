# 提取曲线数据点

程序运行示例：

![动画](https://n.sunie.top:9000/gallery/2022summer/202207092136731.gif)

##  需求

输入：从文献中收集得到的材料热重测试的.jpg/.png格式图片

输出：对应曲线的数据点

涉及的图片类型主要可以分为以下三类：

1）简单线条

![image-20220611175527031](https://n.sunie.top:9000/gallery/2022summer/202206111755722.png) 

2）存在干扰线条（即蓝色线条）

![image-20220611175541345](https://n.sunie.top:9000/gallery/2022summer/202206111755536.png) 

3）复杂线条（存在多条目标曲线）

![image-20220611175603750](https://n.sunie.top:9000/gallery/2022summer/202206111756856.png) 

## 问题分析

![image-20220611181144776](https://n.sunie.top:9000/gallery/2022summer/202206111811628.png)

在上述样例中，所有输入数据有明显的特征，因此相对于普通的曲线提取更加容易。输入特征包含：

1. 曲线大多**被黑色的方框所包围**，方框下方为横坐标，左侧为纵坐标
2. 如果一张图中出现了多条曲线，曲线的**颜色大多不一致**
3. 曲线大多为平滑曲线，从方框最左连续到最右，并且**单调下降**
4. 曲线的形态可以是实线或虚线
5. 曲线标识一般在线条的右上方
5. 图片的背景均为白色

提取流程：

1. 先找到方框或坐标轴所在的位置，将内容裁剪出来识别
2. 通过颜色来区分不同线，多少颜色就输出多少条线，按包含点的数目降序排列。忽略两条线同一颜色的情况
3. 在线上从左到右选点，每次总是选从上到下第一个点，但需要满足单调下降的需求
4. 通过插值或拟合还原原函数，输出100个等距插值点

## 流程

### 方框裁剪

见`tailor.py`，核心思路是寻找x/y坐标轴：

1. 根据横向/纵向像素平均值的大小确定水平和竖直线
2. 在这些线条中，坐标轴一般出现在图片最左或者最下
3. 因为坐标轴另外一侧一定有坐标刻度，排除左/下完全为白色的水平和竖直线
4. 根据坐标轴确定裁剪方框并裁剪

![image-20220709213315230](https://n.sunie.top:9000/gallery/2022summer/202207092133035.png)

### 按色彩分离线条

由于线条有各自的颜色，且线条之间差异较大，可以根据色彩区分不同线条。有以下指标区分线条的差异：

- 色相，转换到hsv空间后，色相为0到1间不同的值
- 亮度，及像素的灰度
- 色彩空间距离，即RGB三者的绝对偏差之和

注：为了方便生成新图，在执行分离之前将图片反色，其中灰度值低于50都被认为是黑色，灰度值高于235都被认为是白色

| round | 色彩数 | 色彩带                                                       |
| ----- | ------ | ------------------------------------------------------------ |
| 0     | 215    | ![image-20220707092403611](https://n.sunie.top:9000/gallery/2022summer/202207070924514.png) |
| 1     | 1647   | <img src="C:\Users\sy650\AppData\Roaming\Typora\typora-user-images\image-20220707092544177.png" alt="image-20220707092544177" style="zoom: 33%;" /> |
| 2     | 6986   |                                                              |
| 3     | 9998   |                                                              |

![image-20220709213412566](https://n.sunie.top:9000/gallery/2022summer/202207092134204.png)

### 顺序选点

从线上从左到右选点，每次总是选从上到下第一个点，但需要满足单调下降的需求。这样选点能够完全避免选到标签的情况，并且因为限制了单调下降，个不可能出现抖动程度过大。

![image-20220709213600083](https://n.sunie.top:9000/gallery/2022summer/202207092136826.png)

### 拟合或插值

#### 拟合

在根据样本点拟合过程中，曲线不一定通过样本点，但困难在于函数形式的定义，很难找到符合条件的函数拟合曲线。下图是使用多项式函数，从-3到+3项数进行拟合的结果，七个系数分别为：

```
[-5.81978492e+01  2.23481625e+02 -1.84351082e+02  1.34665445e+02
 -2.35943787e+00  1.71681831e-02 -1.61449275e-05]
```

可见这种方式并不能很好地表示曲线。

![image-20220709212917925](https://n.sunie.top:9000/gallery/2022summer/202207092129637.png)

#### 插值

![image-20220707230356099](https://n.sunie.top:9000/gallery/2022summer/202207072303511.png)

插值得出的结果要比找到拟合函数容易准确得多，但可能出现抖动或不平滑的现象，如图中圈出的四个地方，插值出来的曲线也会抖动。

解决方式：

1. 在拟合曲线出现抖动的地方，如高阶倒数绝对值较大，删除邻域内的样本点，重新插值。阈值需要人工调整
2. 使用傅里叶描述子重构轮廓，通过调整M项数使轮廓平滑

这一步骤可进一步优化
